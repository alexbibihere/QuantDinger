<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE å®æ—¶ä»·æ ¼æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .price-update {
            animation: flash 0.5s ease-in-out;
        }
        @keyframes flash {
            0% { background-color: rgba(24, 144, 255, 0.3); }
            100% { background-color: transparent; }
        }
        .positive { color: #52c41a; }
        .negative { color: #f5222d; }
    </style>
</head>
<body>
    <h1>SSE å®æ—¶ä»·æ ¼æµ‹è¯•é¡µé¢</h1>

    <div id="status" class="status disconnected">
        çŠ¶æ€: æœªè¿æ¥
    </div>

    <table>
        <thead>
            <tr>
                <th>å¸ç§</th>
                <th>ä»·æ ¼</th>
                <th>æ¶¨è·Œå¹…</th>
                <th>æ—¶é—´</th>
            </tr>
        </thead>
        <tbody id="priceTable">
            <tr><td colspan="4">ç­‰å¾…æ•°æ®...</td></tr>
        </tbody>
    </table>

    <h2>æœ€æ–°æ¶ˆæ¯æ—¥å¿—</h2>
    <pre id="log" style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;"></pre>

    <script>
        const statusDiv = document.getElementById('status');
        const priceTable = document.getElementById('priceTable');
        const logDiv = document.getElementById('log');

        const prices = {};
        let messageCount = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent = `[${timestamp}] ${message}\n` + logDiv.textContent;
            messageCount++;
            if (messageCount > 50) {
                // åªä¿ç•™æœ€è¿‘50æ¡
                logDiv.textContent = logDiv.textContent.split('\n').slice(0, 50).join('\n');
            }
        }

        // è¿æ¥åˆ° SSE
        const eventSource = new EventSource('/api/sse/prices');

        eventSource.addEventListener('connected', (event) => {
            log('âœ… å·²è¿æ¥åˆ°ä»·æ ¼æ¨é€æœåŠ¡');
            statusDiv.textContent = 'çŠ¶æ€: å·²è¿æ¥';
            statusDiv.className = 'status connected';
        });

        eventSource.addEventListener('price', (event) => {
            try {
                const data = JSON.parse(event.data);
                log(`ğŸ“¡ æ”¶åˆ°ä»·æ ¼: ${data.symbol} = ${data.price} (${data.change24h}%)`);

                // å­˜å‚¨ä»·æ ¼æ•°æ®
                prices[data.symbol] = data;

                // æ›´æ–°è¡¨æ ¼
                updateTable();
            } catch (error) {
                log(`âŒ è§£æé”™è¯¯: ${error.message}`);
            }
        });

        eventSource.addEventListener('heartbeat', (event) => {
            log('ğŸ’“ å¿ƒè·³');
        });

        eventSource.onerror = (error) => {
            log('âŒ è¿æ¥é”™è¯¯');
            statusDiv.textContent = 'çŠ¶æ€: è¿æ¥é”™è¯¯';
            statusDiv.className = 'status disconnected';
        };

        eventSource.onopen = () => {
            log('ğŸ”— è¿æ¥å·²æ‰“å¼€');
        };

        function updateTable() {
            const symbols = Object.keys(prices).sort();

            if (symbols.length === 0) {
                priceTable.innerHTML = '<tr><td colspan="4">ç­‰å¾…æ•°æ®...</td></tr>';
                return;
            }

            let html = '';
            symbols.forEach(symbol => {
                const data = prices[symbol];
                const changeClass = data.change24h >= 0 ? 'positive' : 'negative';
                const changeIcon = data.change24h >= 0 ? 'â–²' : 'â–¼';

                html += `
                    <tr class="price-update">
                        <td><strong>${symbol}</strong></td>
                        <td>$${data.price.toFixed(data.price >= 1 ? 4 : 6)}</td>
                        <td class="${changeClass}">${changeIcon} ${Math.abs(data.change24h).toFixed(2)}%</td>
                        <td>${new Date(data.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `;
            });

            priceTable.innerHTML = html;

            // ç§»é™¤é—ªçƒåŠ¨ç”»ç±»
            setTimeout(() => {
                const rows = priceTable.querySelectorAll('tr');
                rows.forEach(row => row.classList.remove('price-update'));
            }, 500);
        }

        log('æ­£åœ¨è¿æ¥åˆ° SSE...');
    </script>
</body>
</html>
