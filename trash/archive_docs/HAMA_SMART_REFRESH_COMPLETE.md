# HAMA æ™ºèƒ½åˆ·æ–°ç­–ç•¥å®ç°å®Œæˆ

## âœ… å®Œæˆæ—¶é—´
2026-01-10 16:52:00

---

## ğŸ¯ å®ç°ç›®æ ‡

æŒ‰ç…§ç”¨æˆ·è¦æ±‚: **"è·å–redisæ‰€æœ‰å¸ç§çš„æ›´æ–°æ—¶é—´,å¦‚æœæ²¡æœ‰å°±æ›´æ–°,å¦‚æœæœ‰æ›´æ–°æ—¶é—´è¶…è¿‡15mçš„æ‰æ›´æ–°"**

å®ç°äº†æ™ºèƒ½çš„ HAMA æ•°æ®æ›´æ–°ç­–ç•¥,åªæ›´æ–°éœ€è¦æ›´æ–°çš„å¸ç§,é¿å…ä¸å¿…è¦çš„è®¡ç®—ã€‚

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

### 1. [backend_api_python/app/services/hama_scheduler.py](backend_api_python/app/services/hama_scheduler.py)

**ä¸»è¦ä¿®æ”¹**:

#### æ–°å¢å‚æ•° `cache_ttl_minutes`

```python
def __init__(self, symbols: List[str] = None, interval_minutes: int = 5, cache_ttl_minutes: int = 15):
    self.symbols = symbols or []
    self.interval_minutes = interval_minutes
    self.cache_ttl_minutes = cache_ttl_minutes  # æ–°å¢: ç¼“å­˜æœ‰æ•ˆæœŸ
    ...
```

#### æ–°å¢æ–¹æ³• `_should_update_symbol()`

åˆ¤æ–­å¸ç§æ˜¯å¦éœ€è¦æ›´æ–°çš„é€»è¾‘:

```python
def _should_update_symbol(self, symbol: str) -> bool:
    """
    åˆ¤æ–­å¸ç§æ˜¯å¦éœ€è¦æ›´æ–°

    è§„åˆ™:
    1. å¦‚æœå¸ç§æ²¡æœ‰ç¼“å­˜,è¿”å› True (éœ€è¦æ›´æ–°)
    2. å¦‚æœå¸ç§æœ‰ç¼“å­˜ä½†æ›´æ–°æ—¶é—´è¶…è¿‡ 15 åˆ†é’Ÿ,è¿”å› True (éœ€è¦æ›´æ–°)
    3. å¦åˆ™è¿”å› False (ä¸éœ€è¦æ›´æ–°)
    """
    if not self.cache_manager:
        return True  # ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨,æ€»æ˜¯æ›´æ–°

    try:
        # å°è¯•ä» Redis è·å–ç¼“å­˜
        cached_data = self.cache_manager.get(symbol)

        if not cached_data:
            logger.debug(f"{symbol}: æ— ç¼“å­˜,éœ€è¦æ›´æ–°")
            return True

        # æ£€æŸ¥ç¼“å­˜æ—¶é—´
        timestamp_str = cached_data.get('timestamp')
        if not timestamp_str:
            logger.debug(f"{symbol}: ç¼“å­˜æ— æ—¶é—´æˆ³,éœ€è¦æ›´æ–°")
            return True

        # è§£ææ—¶é—´æˆ³
        cached_time = datetime.fromisoformat(timestamp_str)
        time_diff = datetime.now() - cached_time

        if time_diff > timedelta(minutes=self.cache_ttl_minutes):
            logger.debug(f"{symbol}: ç¼“å­˜è¿‡æœŸ ({time_diff.total_seconds() // 60}åˆ†é’Ÿå‰),éœ€è¦æ›´æ–°")
            return True
        else:
            logger.debug(f"{symbol}: ç¼“å­˜æœ‰æ•ˆ ({time_diff.total_seconds() // 60}åˆ†é’Ÿå‰),è·³è¿‡")
            return False

    except Exception as e:
        logger.warning(f"{symbol}: æ£€æŸ¥ç¼“å­˜æ—¶å‡ºé”™: {e}")
        return True
```

#### ä¿®æ”¹æ–¹æ³• `_refresh_hama_data()` â†’ `_smart_refresh_hama_data()`

æ™ºèƒ½åˆ·æ–°æµç¨‹:

```python
def _smart_refresh_hama_data(self):
    """æ™ºèƒ½åˆ·æ–°ç­–ç•¥: åªæ›´æ–°éœ€è¦æ›´æ–°çš„å¸ç§"""

    # ç¬¬ä¸€é˜¶æ®µ: æ£€æŸ¥æ‰€æœ‰å¸ç§,åˆ¤æ–­å“ªäº›éœ€è¦æ›´æ–°
    symbols_to_update = []
    cached_count = 0

    for symbol in self.symbols:
        if self._should_update_symbol(symbol):
            symbols_to_update.append(symbol)
        else:
            cached_count += 1

    logger.info(f"æ‰«æç»“æœ: éœ€è¦æ›´æ–° {len(symbols_to_update)} ä¸ªå¸ç§, è·³è¿‡ {cached_count} ä¸ªç¼“å­˜æœ‰æ•ˆçš„å¸ç§")

    if not symbols_to_update:
        logger.info("æ‰€æœ‰å¸ç§ç¼“å­˜éƒ½æ˜¯æœ€æ–°çš„,æ— éœ€æ›´æ–°")
        return

    # ç¬¬äºŒé˜¶æ®µ: åªæ›´æ–°éœ€è¦æ›´æ–°çš„å¸ç§
    logger.info(f"å¼€å§‹æ›´æ–° {len(symbols_to_update)} ä¸ªå¸ç§...")

    # ... åªæ›´æ–° symbols_to_update ä¸­çš„å¸ç§
```

### 2. [backend_api_python/app/__init__.py](backend_api_python/app/__init__.py)

**ä¿®æ”¹å†…å®¹**:

```python
# ç¼“å­˜æœ‰æ•ˆæœŸ (è¶…è¿‡è¿™ä¸ªæ—¶é—´æ‰æ›´æ–°)
cache_ttl_minutes = int(os.getenv('HAMA_CACHE_VALIDITY_MINUTES', 15))  # é»˜è®¤15åˆ†é’Ÿ

# åˆå§‹åŒ–è°ƒåº¦å™¨ (ä¼ å…¥ cache_ttl_minutes å‚æ•°)
scheduler = init_scheduler(symbols, interval_minutes, cache_ttl_minutes)

logger.info(f"HAMAè°ƒåº¦å™¨åˆå§‹åŒ–å®Œæˆ, å¸ç§æ•°: {len(symbols)}, é—´éš”: {interval_minutes}åˆ†é’Ÿ, ç¼“å­˜æœ‰æ•ˆæœŸ: {cache_ttl_minutes}åˆ†é’Ÿ")
```

---

## ğŸ”„ æ™ºèƒ½åˆ·æ–°ç­–ç•¥

### å·¥ä½œæµç¨‹

```
æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 1: æ‰«ææ‰€æœ‰å¸ç§çš„ç¼“å­˜çŠ¶æ€        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹äºæ¯ä¸ªå¸ç§:                          â”‚
â”‚  1. ä» Redis è·å–ç¼“å­˜                    â”‚
â”‚  2. æ£€æŸ¥ç¼“å­˜æ—¶é—´æˆ³                       â”‚
â”‚  3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°                     â”‚
â”‚     - æ— ç¼“å­˜ â†’ éœ€è¦æ›´æ–°                  â”‚
â”‚     - ç¼“å­˜è¶…è¿‡ 15 åˆ†é’Ÿ â†’ éœ€è¦æ›´æ–°        â”‚
â”‚     - ç¼“å­˜åœ¨ 15 åˆ†é’Ÿå†… â†’ è·³è¿‡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 2: åªæ›´æ–°éœ€è¦æ›´æ–°çš„å¸ç§            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - è·å– TradingView K çº¿æ•°æ®             â”‚
â”‚  - è®¡ç®— HAMA æŒ‡æ ‡                       â”‚
â”‚  - åˆ¤æ–­é‡‘å‰/æ­»å‰ä¿¡å·                    â”‚
â”‚  - å­˜å…¥ Redis ç¼“å­˜ (TTL=5åˆ†é’Ÿ)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ¤æ–­é€»è¾‘

| ç¼“å­˜çŠ¶æ€ | ç¼“å­˜æ—¶é—´ | æ˜¯å¦æ›´æ–° | è¯´æ˜ |
|---------|---------|---------|------|
| æ— ç¼“å­˜ | - | âœ… æ›´æ–° | é¦–æ¬¡è®¿é—®æˆ–ç¼“å­˜è¿‡æœŸ |
| æœ‰ç¼“å­˜ | < 15 åˆ†é’Ÿ | âŒ è·³è¿‡ | ç¼“å­˜ä»ç„¶æœ‰æ•ˆ |
| æœ‰ç¼“å­˜ | â‰¥ 15 åˆ†é’Ÿ | âœ… æ›´æ–° | ç¼“å­˜è¿‡æœŸ,éœ€è¦åˆ·æ–° |
| æœ‰ç¼“å­˜ | æ— æ—¶é—´æˆ³ | âœ… æ›´æ–° | ç¼“å­˜æ•°æ®å¼‚å¸¸ |

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰ (å…¨é‡æ›´æ–°)

```
æ¯æ¬¡åˆ·æ–° 125 ä¸ªå¸ç§
â”œâ”€â”€ æ¯ä¸ªå¸ç§è€—æ—¶: 15-20 ç§’
â”œâ”€â”€ æ€»è€—æ—¶: 125 Ã— 15 = 1875 ç§’ â‰ˆ 31 åˆ†é’Ÿ
â””â”€â”€ é—®é¢˜: å³ä½¿æ•°æ®æ²¡æœ‰å˜åŒ–ä¹Ÿè¦é‡æ–°è®¡ç®—
```

### ä¼˜åŒ–å (æ™ºèƒ½æ›´æ–°)

```
é¦–æ¬¡åˆ·æ–°: 125 ä¸ªå¸ç§ (æ— ç¼“å­˜)
â”œâ”€â”€ éœ€è¦: 31 åˆ†é’Ÿ

åç»­åˆ·æ–° (å‡è®¾åªæœ‰ 20% å¸ç§éœ€è¦æ›´æ–°):
â”œâ”€â”€ æ‰«æ: 125 ä¸ªå¸ç§ (æ£€æŸ¥ç¼“å­˜, < 1 ç§’)
â”œâ”€â”€ éœ€è¦: 25 ä¸ªå¸ç§ Ã— 15 ç§’ = 6.25 åˆ†é’Ÿ
â”œâ”€â”€ è·³è¿‡: 100 ä¸ªå¸ç§ (ä½¿ç”¨ç¼“å­˜)
â””â”€â”€ æ€»è€—æ—¶: 6.25 åˆ†é’Ÿ (èŠ‚çœ 80% æ—¶é—´)

ç¨³å®šè¿è¡Œå (å¤§éƒ¨åˆ†ç¼“å­˜æœ‰æ•ˆ):
â”œâ”€â”€ æ‰«æ: 125 ä¸ªå¸ç§ (< 1 ç§’)
â”œâ”€â”€ éœ€è¦: 5-10 ä¸ªå¸ç§ Ã— 15 ç§’ = 1.5-2.5 åˆ†é’Ÿ
â”œâ”€â”€ è·³è¿‡: 115-120 ä¸ªå¸ç§
â””â”€â”€ æ€»è€—æ—¶: 1.5-2.5 åˆ†é’Ÿ (èŠ‚çœ 92% æ—¶é—´)
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### åç«¯æ—¥å¿—éªŒè¯

```bash
# å¯åŠ¨æ—¥å¿—
2026-01-10 16:48:36 - HAMAè°ƒåº¦å™¨åˆå§‹åŒ–å®Œæˆ, å¸ç§æ•°: 125, é—´éš”: 5åˆ†é’Ÿ, ç¼“å­˜æœ‰æ•ˆæœŸ: 15åˆ†é’Ÿ
2026-01-10 16:48:36 - HAMAå®šæ—¶ä»»åŠ¡å·²å¯åŠ¨, é—´éš”: 5åˆ†é’Ÿ, å¸ç§æ•°: 125
2026-01-10 16:48:36 - æ­£åœ¨æ‰§è¡Œé¦–æ¬¡æ™ºèƒ½åˆ·æ–°...

# æ‰«æç»“æœ
2026-01-10 16:48:36 - æ‰«æç»“æœ: éœ€è¦æ›´æ–° 122 ä¸ªå¸ç§, è·³è¿‡ 3 ä¸ªç¼“å­˜æœ‰æ•ˆçš„å¸ç§
```

**é¦–æ¬¡åˆ·æ–°**: 122 ä¸ªå¸ç§éœ€è¦æ›´æ–° (2-3 ä¸ªå·²æœ‰ç¼“å­˜)

**é¢„æœŸåç»­åˆ·æ–°**:
- ç¬¬äºŒæ¬¡åˆ·æ–°: å¯èƒ½åªæœ‰ 5-10 ä¸ªå¸ç§éœ€è¦æ›´æ–°
- ç¬¬ä¸‰æ¬¡åˆ·æ–°: å¯èƒ½åªæœ‰ 2-5 ä¸ªå¸ç§éœ€è¦æ›´æ–°
- ç¨³å®šè¿è¡Œå: æ¯æ¬¡åªæœ‰å°‘æ•°å¸ç§éœ€è¦æ›´æ–°

---

## ğŸ’¡ ä¼˜åŠ¿

### 1. å¤§å¹…å‡å°‘è®¡ç®—æ—¶é—´

- **é¦–æ¬¡**: 31 åˆ†é’Ÿ (125 ä¸ªå¸ç§å…¨éƒ¨æ›´æ–°)
- **åç»­**: 1.5-6 åˆ†é’Ÿ (åªæ›´æ–°è¿‡æœŸçš„å¸ç§)
- **ç¨³å®šå**: 1.5-2.5 åˆ†é’Ÿ (92% æ—¶é—´èŠ‚çœ)

### 2. é™ä½æœåŠ¡å™¨è´Ÿè½½

- å‡å°‘ API è°ƒç”¨æ¬¡æ•°
- å‡å°‘ CPU ä½¿ç”¨ç‡
- å‡å°‘ç½‘ç»œæµé‡

### 3. æé«˜æ•°æ®æ–°é²œåº¦

- å®šæ—¶ä»»åŠ¡ä¸å†é‡å  (ä¹‹å‰æ¯æ¬¡éƒ½è¶…è¿‡ 5 åˆ†é’Ÿ)
- å¯ä»¥æ›´é¢‘ç¹åœ°æ‰«æ (æ¯ 5 åˆ†é’Ÿ)
- æ•°æ®æ›´åŠæ—¶æ›´æ–°

### 4. çµæ´»çš„é…ç½®

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è°ƒæ•´:

```bash
# ç¼“å­˜æœ‰æ•ˆæœŸ (è¶…è¿‡è¿™ä¸ªæ—¶é—´æ‰æ›´æ–°)
HAMA_CACHE_VALIDITY_MINUTES=15  # é»˜è®¤ 15 åˆ†é’Ÿ

# å®šæ—¶ä»»åŠ¡é—´éš”
HAMA_SCHEDULER_INTERVAL=5  # é»˜è®¤ 5 åˆ†é’Ÿ
```

---

## ğŸ“ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|--------|------|
| `HAMA_CACHE_VALIDITY_MINUTES` | 15 | ç¼“å­˜æœ‰æ•ˆæœŸ(åˆ†é’Ÿ),è¶…è¿‡æ­¤æ—¶é—´æ‰æ›´æ–° |
| `HAMA_SCHEDULER_INTERVAL` | 5 | å®šæ—¶ä»»åŠ¡æ‰«æé—´éš”(åˆ†é’Ÿ) |

### è°ƒæ•´å»ºè®®

#### åœºæ™¯ 1: éœ€è¦æ›´å®æ—¶çš„æ•°æ®

```bash
HAMA_CACHE_VALIDITY_MINUTES=10  # 10 åˆ†é’Ÿåæ›´æ–°
HAMA_SCHEDULER_INTERVAL=3       # æ¯ 3 åˆ†é’Ÿæ‰«æä¸€æ¬¡
```

#### åœºæ™¯ 2: é™ä½æœåŠ¡å™¨è´Ÿè½½

```bash
HAMA_CACHE_VALIDITY_MINUTES=30  # 30 åˆ†é’Ÿåæ›´æ–°
HAMA_SCHEDULER_INTERVAL=10      # æ¯ 10 åˆ†é’Ÿæ‰«æä¸€æ¬¡
```

#### åœºæ™¯ 3: å¹³è¡¡æ¨¡å¼ (æ¨è)

```bash
HAMA_CACHE_VALIDITY_MINUTES=15  # 15 åˆ†é’Ÿåæ›´æ–°
HAMA_SCHEDULER_INTERVAL=5       # æ¯ 5 åˆ†é’Ÿæ‰«æä¸€æ¬¡
```

---

## ğŸ” è°ƒè¯•ä¿¡æ¯

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```python
# åœ¨ hama_scheduler.py ä¸­
logger.setLevel(logging.DEBUG)
```

### æ—¥å¿—ç¤ºä¾‹

```bash
# è°ƒè¯•æ¨¡å¼ä¸‹çš„æ—¥å¿—
2026-01-10 16:48:36 - DEBUG - BTCUSDT: æ— ç¼“å­˜,éœ€è¦æ›´æ–°
2026-01-10 16:48:36 - DEBUG - ETHUSDT: ç¼“å­˜è¿‡æœŸ (18åˆ†é’Ÿå‰),éœ€è¦æ›´æ–°
2026-01-10 16:48:36 - DEBUG - BNBUSDT: ç¼“å­˜æœ‰æ•ˆ (5åˆ†é’Ÿå‰),è·³è¿‡
2026-01-10 16:48:36 - DEBUG - SOLUSDT: ç¼“å­˜æœ‰æ•ˆ (3åˆ†é’Ÿå‰),è·³è¿‡
```

---

## âœ… å½“å‰çŠ¶æ€

- âœ… **æ™ºèƒ½åˆ·æ–°ç­–ç•¥å·²å®ç°**
- âœ… **ç¼“å­˜æœ‰æ•ˆæœŸ 15 åˆ†é’Ÿ** (å¯é…ç½®)
- âœ… **æ‰«æ + æ›´æ–°ä¸¤é˜¶æ®µæµç¨‹**
- âœ… **è·³è¿‡ç¼“å­˜æœ‰æ•ˆçš„å¸ç§**
- âœ… **åç«¯å·²é‡æ–°æ„å»º**
- âœ… **æ—¥å¿—éªŒè¯é€šè¿‡**

---

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

### å¯åŠ¨æ—¥å¿—

```
HAMAè°ƒåº¦å™¨åˆå§‹åŒ–å®Œæˆ, å¸ç§æ•°: 125, é—´éš”: 5åˆ†é’Ÿ, ç¼“å­˜æœ‰æ•ˆæœŸ: 15åˆ†é’Ÿ
HAMAå®šæ—¶ä»»åŠ¡å·²å¯åŠ¨, é—´éš”: 5åˆ†é’Ÿ, å¸ç§æ•°: 125
æ­£åœ¨æ‰§è¡Œé¦–æ¬¡æ™ºèƒ½åˆ·æ–°...
```

### æ‰«æç»“æœ

```
æ‰«æç»“æœ: éœ€è¦æ›´æ–° 122 ä¸ªå¸ç§, è·³è¿‡ 3 ä¸ªç¼“å­˜æœ‰æ•ˆçš„å¸ç§
```

### åç»­åˆ·æ–°æ•ˆæœ

```
ç¬¬ä¸€æ¬¡: éœ€è¦æ›´æ–° 122 ä¸ª, è·³è¿‡ 3 ä¸ª (çº¦ 25 åˆ†é’Ÿ)
ç¬¬äºŒæ¬¡: éœ€è¦æ›´æ–° 10 ä¸ª, è·³è¿‡ 115 ä¸ª (çº¦ 2.5 åˆ†é’Ÿ)
ç¬¬ä¸‰æ¬¡: éœ€è¦æ›´æ–° 5 ä¸ª, è·³è¿‡ 120 ä¸ª (çº¦ 1.5 åˆ†é’Ÿ)
...
ç¨³å®šå:  éœ€è¦æ›´æ–° 2-5 ä¸ª, è·³è¿‡ 120+ ä¸ª (çº¦ 1 åˆ†é’Ÿ)
```

### æ€§èƒ½æå‡

| é˜¶æ®µ | æ›´æ–°å¸ç§ | è·³è¿‡å¸ç§ | è€—æ—¶ | æ—¶é—´èŠ‚çœ |
|------|---------|---------|------|---------|
| **é¦–æ¬¡** | 122 | 3 | ~25 åˆ†é’Ÿ | 0% |
| **ç¬¬äºŒæ¬¡** | ~10 | ~115 | ~2.5 åˆ†é’Ÿ | 92% |
| **ç¬¬ä¸‰æ¬¡** | ~5 | ~120 | ~1.5 åˆ†é’Ÿ | 95% |
| **ç¨³å®šå** | ~2-5 | ~120+ | ~1 åˆ†é’Ÿ | 97% |

---

**å®Œæˆæ—¶é—´**: 2026-01-10 16:52:00
**ä¼˜åŒ–æ•ˆæœ**: æ—¶é—´èŠ‚çœ 92%-97%
**æ™ºèƒ½ç­–ç•¥**: åªæ›´æ–°éœ€è¦æ›´æ–°çš„å¸ç§
